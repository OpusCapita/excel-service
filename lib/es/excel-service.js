/* eslint-disable no-underscore-dangle */
import XLSX from 'xlsx';
import { saveAs } from 'file-saver';

import { getColumns, convertArrayBufferToString, convertStringToArrayBuffer, convertValueType } from './excel-service.utils';

var createWorksheet = function createWorksheet(data, columns, digits) {
  XLSX.SSF._table[161] = '0.0';
  XLSX.SSF._table[162] = '0.000';
  XLSX.SSF._table[163] = '0.0000';
  XLSX.SSF._table[164] = '0.00000';
  XLSX.SSF._table[165] = '0.000000';
  var sheet = {};
  var sheetColumns = [];
  var range = { s: { c: 0, r: 0 }, e: { c: columns.length - 1, r: data.size } };
  var cellRef = {};
  columns.forEach(function (col, colIndex) {
    cellRef = XLSX.utils.encode_cell({ c: colIndex, r: 0 });
    var header = col.headerText ? String(col.headerText) : String(col.header);
    sheet[cellRef] = { t: 's', v: header };
    sheetColumns.push({ wpx: col.width });
  });
  data.forEach(function (row, rowIndex) {
    columns.forEach(function (col, colIndex) {
      var cellData = col.valueKeyPath ? row.getIn(col.valueKeyPath) : '';
      if (col.valueRender !== undefined && !col.disableValueRenderInExcel) {
        cellData = String(col.valueRender(row));
      }
      if (col.valueTypeExcel) {
        cellData = convertValueType(cellData, col.valueTypeExcel);
      }
      if (cellData === null || cellData === undefined) {
        cellData = '';
      }
      var cell = { v: cellData };
      cellRef = XLSX.utils.encode_cell({ c: colIndex, r: rowIndex + 1 });
      if (typeof cell.v === 'number') {
        cell.t = 'n';
        if (Array.isArray(digits) && Number(digits[rowIndex][col.valueKeyPath.join('/')]) > -1) {
          cell.z = Number(XLSX.SSF._table[2]).toFixed(digits[rowIndex][col.valueKeyPath.join('/')]);
        } else if (Number(digits) > -1) {
          cell.z = Number(XLSX.SSF._table[2]).toFixed(digits);
        }
      } else if (typeof cell.v === 'boolean') {
        cell.t = 'b';
      } else {
        cell.t = 's';
      }
      sheet[cellRef] = cell;
    });
  });
  sheet['!cols'] = sheetColumns;
  sheet['!ref'] = XLSX.utils.encode_range(range);
  return sheet;
};

/**
 * Export data to Excel
 * Input:
 * data is a List of data to export,
 * columns is an array of column objects with the keys:
 * {
 *  header :: string or element, defines the column name,
 *  valueKeyPath :: array of strings, defines the column id,
 *  width :: number, width in pixels,
 *  disableValueRenderInExcel :: bool (optional), disable valueRender callback for export to Excel,
 *    instead export value directly
 *  headerText :: string (optional), needed if 'header' is not a text,
 *  valueRender :: function (optional), defines a render function,
 *  valueTypeExcel :: string (optional), defines a value type for Excel if differs from UI
 * },
 * fileName is a file name string (optional),
 * digits is a number of digits for decimals in all table or an array containing digits
 * for cells (optional),
 * visibleColumns is a list of visible columns in case column settings is used (optional).
 */
export var exportToExcel = function exportToExcel(data, columns) {
  var fileName = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'Export From OC';
  var digits = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;
  var visibleColumns = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : null;

  var sheetName = 'Sheet1';
  var exportedColumns = getColumns(columns, visibleColumns);
  var sheet = createWorksheet(data, exportedColumns, digits);
  var book = { SheetNames: [sheetName], Sheets: {} };
  book.Sheets[sheetName] = sheet;
  var bookOut = XLSX.write(book, { bookType: 'xlsx', bookSST: true, type: 'binary' });
  // console.log(book, bookOut, convertStringToArrayBuffer(bookOut));
  saveAs(new Blob([convertStringToArrayBuffer(bookOut)], { type: 'application/octet-stream' }), fileName + '.xlsx');
};

/**
 * Import data from Excel
 * Input:
 * files is an event.target.files array,
 * callback is onLoad callback called from a parent component,
 * alertCallback is a callback for error alert (optional).
 */
export var importFromExcel = function importFromExcel(files, callback) {
  var alertCallback = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;

  if (files.length === 0) {
    return;
  }
  if (alertCallback && files[0].type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
    alertCallback();
    return;
  }
  var reader = new FileReader();
  reader.onload = callback;
  reader.readAsArrayBuffer(files[0]);
};

/**
 * Callback on load of FileReader for import operation
 * Input:
 * e is an event object,
 * columns is an array of column objects with the keys:
 * {
 *  valueKeyPath :: array of strings,
 *  valueExcelMatch :: function (optional),
 *  defaultValue :: any,
 * },
 * visibleColumns is a list of visible columns ids in case column settings is used (optional).
 * Output:
 * an array of data.
 */
export var onLoadCallback = function onLoadCallback(e, columns) {
  var visibleColumns = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;

  var result = convertArrayBufferToString(e.target.result);
  var book = XLSX.read(btoa(result), { type: 'base64' });
  var rawData = XLSX.utils.sheet_to_json(book.Sheets[book.SheetNames[0]], { header: 1, raw: true });
  if (Array.isArray(rawData) && rawData.length < 2) {
    return [];
  }
  var importedColumns = getColumns(columns, visibleColumns);
  var data = [];
  rawData.forEach(function (row, rowIndex) {
    // skip the header
    if (rowIndex >= 1) {
      var item = {};
      row.forEach(function (cell, cellIndex) {
        if (cellIndex < importedColumns.length) {
          var value = importedColumns[cellIndex].valueExcelMatch !== undefined ? importedColumns[cellIndex].valueExcelMatch(cell) : cell;
          item[importedColumns[cellIndex].valueKeyPath[0]] = value;
        }
      });
      importedColumns.forEach(function (column) {
        if (column.defaultValue !== undefined && item[column.valueKeyPath[0]] === undefined) {
          item[column.valueKeyPath[0]] = column.defaultValue;
        }
      });
      data.push(item);
    }
  });
  return data;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leGNlbC1zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbIlhMU1giLCJzYXZlQXMiLCJnZXRDb2x1bW5zIiwiY29udmVydEFycmF5QnVmZmVyVG9TdHJpbmciLCJjb252ZXJ0U3RyaW5nVG9BcnJheUJ1ZmZlciIsImNvbnZlcnRWYWx1ZVR5cGUiLCJjcmVhdGVXb3Jrc2hlZXQiLCJkYXRhIiwiY29sdW1ucyIsImRpZ2l0cyIsIlNTRiIsIl90YWJsZSIsInNoZWV0Iiwic2hlZXRDb2x1bW5zIiwicmFuZ2UiLCJzIiwiYyIsInIiLCJlIiwibGVuZ3RoIiwic2l6ZSIsImNlbGxSZWYiLCJmb3JFYWNoIiwiY29sIiwiY29sSW5kZXgiLCJ1dGlscyIsImVuY29kZV9jZWxsIiwiaGVhZGVyIiwiaGVhZGVyVGV4dCIsIlN0cmluZyIsInQiLCJ2IiwicHVzaCIsIndweCIsIndpZHRoIiwicm93Iiwicm93SW5kZXgiLCJjZWxsRGF0YSIsInZhbHVlS2V5UGF0aCIsImdldEluIiwidmFsdWVSZW5kZXIiLCJ1bmRlZmluZWQiLCJkaXNhYmxlVmFsdWVSZW5kZXJJbkV4Y2VsIiwidmFsdWVUeXBlRXhjZWwiLCJjZWxsIiwiQXJyYXkiLCJpc0FycmF5IiwiTnVtYmVyIiwiam9pbiIsInoiLCJ0b0ZpeGVkIiwiZW5jb2RlX3JhbmdlIiwiZXhwb3J0VG9FeGNlbCIsImZpbGVOYW1lIiwidmlzaWJsZUNvbHVtbnMiLCJzaGVldE5hbWUiLCJleHBvcnRlZENvbHVtbnMiLCJib29rIiwiU2hlZXROYW1lcyIsIlNoZWV0cyIsImJvb2tPdXQiLCJ3cml0ZSIsImJvb2tUeXBlIiwiYm9va1NTVCIsInR5cGUiLCJCbG9iIiwiaW1wb3J0RnJvbUV4Y2VsIiwiZmlsZXMiLCJjYWxsYmFjayIsImFsZXJ0Q2FsbGJhY2siLCJyZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwicmVhZEFzQXJyYXlCdWZmZXIiLCJvbkxvYWRDYWxsYmFjayIsInJlc3VsdCIsInRhcmdldCIsInJlYWQiLCJidG9hIiwicmF3RGF0YSIsInNoZWV0X3RvX2pzb24iLCJyYXciLCJpbXBvcnRlZENvbHVtbnMiLCJpdGVtIiwiY2VsbEluZGV4IiwidmFsdWUiLCJ2YWx1ZUV4Y2VsTWF0Y2giLCJjb2x1bW4iLCJkZWZhdWx0VmFsdWUiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsT0FBT0EsSUFBUCxNQUFpQixNQUFqQjtBQUNBLFNBQVNDLE1BQVQsUUFBdUIsWUFBdkI7O0FBRUEsU0FDRUMsVUFERixFQUVFQywwQkFGRixFQUdFQywwQkFIRixFQUlFQyxnQkFKRixRQUtPLHVCQUxQOztBQU9BLElBQU1DLGtCQUFrQixTQUFsQkEsZUFBa0IsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCQyxNQUFoQixFQUEyQjtBQUNqRFQsT0FBS1UsR0FBTCxDQUFTQyxNQUFULENBQWdCLEdBQWhCLElBQXVCLEtBQXZCO0FBQ0FYLE9BQUtVLEdBQUwsQ0FBU0MsTUFBVCxDQUFnQixHQUFoQixJQUF1QixPQUF2QjtBQUNBWCxPQUFLVSxHQUFMLENBQVNDLE1BQVQsQ0FBZ0IsR0FBaEIsSUFBdUIsUUFBdkI7QUFDQVgsT0FBS1UsR0FBTCxDQUFTQyxNQUFULENBQWdCLEdBQWhCLElBQXVCLFNBQXZCO0FBQ0FYLE9BQUtVLEdBQUwsQ0FBU0MsTUFBVCxDQUFnQixHQUFoQixJQUF1QixVQUF2QjtBQUNBLE1BQU1DLFFBQVEsRUFBZDtBQUNBLE1BQU1DLGVBQWUsRUFBckI7QUFDQSxNQUFNQyxRQUFRLEVBQUVDLEdBQUcsRUFBRUMsR0FBRyxDQUFMLEVBQVFDLEdBQUcsQ0FBWCxFQUFMLEVBQXFCQyxHQUFHLEVBQUVGLEdBQUdSLFFBQVFXLE1BQVIsR0FBaUIsQ0FBdEIsRUFBeUJGLEdBQUdWLEtBQUthLElBQWpDLEVBQXhCLEVBQWQ7QUFDQSxNQUFJQyxVQUFVLEVBQWQ7QUFDQWIsVUFBUWMsT0FBUixDQUFnQixVQUFDQyxHQUFELEVBQU1DLFFBQU4sRUFBbUI7QUFDakNILGNBQVVyQixLQUFLeUIsS0FBTCxDQUFXQyxXQUFY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LFNBQWhCLEVBQTJCRSxlQUEzQixDQUEyQzFDLElBQTNDLENBRFksR0FDdUNBLElBRHJEO0FBRUF1QyxlQUFLRCxnQkFBZ0JFLFNBQWhCLEVBQTJCOUMsWUFBM0IsQ0FBd0MsQ0FBeEMsQ0FBTCxJQUFtRCtDLEtBQW5EO0FBQ0Q7QUFDRixPQU5EO0FBT0FILHNCQUFnQjVELE9BQWhCLENBQXdCLFVBQUNpRSxNQUFELEVBQVk7QUFDbEMsWUFBSUEsT0FBT0MsWUFBUCxLQUF3Qi9DLFNBQXhCLElBQXFDMEMsS0FBS0ksT0FBT2pELFlBQVAsQ0FBb0IsQ0FBcEIsQ0FBTCxNQUFpQ0csU0FBMUUsRUFBcUY7QUFDbkYwQyxlQUFLSSxPQUFPakQsWUFBUCxDQUFvQixDQUFwQixDQUFMLElBQStCaUQsT0FBT0MsWUFBdEM7QUFDRDtBQUNGLE9BSkQ7QUFLQWpGLFdBQUt5QixJQUFMLENBQVVtRCxJQUFWO0FBQ0Q7QUFDRixHQWxCRDtBQW1CQSxTQUFPNUUsSUFBUDtBQUNELENBOUJNIiwiZmlsZSI6ImV4Y2VsLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11bmRlcnNjb3JlLWRhbmdsZSAqL1xuaW1wb3J0IFhMU1ggZnJvbSAneGxzeCc7XG5pbXBvcnQgeyBzYXZlQXMgfSBmcm9tICdmaWxlLXNhdmVyJztcblxuaW1wb3J0IHtcbiAgZ2V0Q29sdW1ucyxcbiAgY29udmVydEFycmF5QnVmZmVyVG9TdHJpbmcsXG4gIGNvbnZlcnRTdHJpbmdUb0FycmF5QnVmZmVyLFxuICBjb252ZXJ0VmFsdWVUeXBlLFxufSBmcm9tICcuL2V4Y2VsLXNlcnZpY2UudXRpbHMnO1xuXG5jb25zdCBjcmVhdGVXb3Jrc2hlZXQgPSAoZGF0YSwgY29sdW1ucywgZGlnaXRzKSA9PiB7XG4gIFhMU1guU1NGLl90YWJsZVsxNjFdID0gJzAuMCc7XG4gIFhMU1guU1NGLl90YWJsZVsxNjJdID0gJzAuMDAwJztcbiAgWExTWC5TU0YuX3RhYmxlWzE2M10gPSAnMC4wMDAwJztcbiAgWExTWC5TU0YuX3RhYmxlWzE2NF0gPSAnMC4wMDAwMCc7XG4gIFhMU1guU1NGLl90YWJsZVsxNjVdID0gJzAuMDAwMDAwJztcbiAgY29uc3Qgc2hlZXQgPSB7fTtcbiAgY29uc3Qgc2hlZXRDb2x1bW5zID0gW107XG4gIGNvbnN0IHJhbmdlID0geyBzOiB7IGM6IDAsIHI6IDAgfSwgZTogeyBjOiBjb2x1bW5zLmxlbmd0aCAtIDEsIHI6IGRhdGEuc2l6ZSB9IH07XG4gIGxldCBjZWxsUmVmID0ge307XG4gIGNvbHVtbnMuZm9yRWFjaCgoY29sLCBjb2xJbmRleCkgPT4ge1xuICAgIGNlbGxSZWYgPSBYTFNYLnV0aWxzLmVuY29kZV9jZWxsKHsgYzogY29sSW5kZXgsIHI6IDAgfSk7XG4gICAgY29uc3QgaGVhZGVyID0gY29sLmhlYWRlclRleHQgPyBTdHJpbmcoY29sLmhlYWRlclRleHQpIDogU3RyaW5nKGNvbC5oZWFkZXIpO1xuICAgIHNoZWV0W2NlbGxSZWZdID0geyB0OiAncycsIHY6IGhlYWRlciB9O1xuICAgIHNoZWV0Q29sdW1ucy5wdXNoKHsgd3B4OiBjb2wud2lkdGggfSk7XG4gIH0pO1xuICBkYXRhLmZvckVhY2goKHJvdywgcm93SW5kZXgpID0+IHtcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbCwgY29sSW5kZXgpID0+IHtcbiAgICAgIGxldCBjZWxsRGF0YSA9IGNvbC52YWx1ZUtleVBhdGggPyByb3cuZ2V0SW4oY29sLnZhbHVlS2V5UGF0aCkgOiAnJztcbiAgICAgIGlmIChjb2wudmFsdWVSZW5kZXIgIT09IHVuZGVmaW5lZCAmJiAhY29sLmRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwpIHtcbiAgICAgICAgY2VsbERhdGEgPSBTdHJpbmcoY29sLnZhbHVlUmVuZGVyKHJvdykpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbC52YWx1ZVR5cGVFeGNlbCkge1xuICAgICAgICBjZWxsRGF0YSA9IGNvbnZlcnRWYWx1ZVR5cGUoY2VsbERhdGEsIGNvbC52YWx1ZVR5cGVFeGNlbCk7XG4gICAgICB9XG4gICAgICBpZiAoY2VsbERhdGEgPT09IG51bGwgfHwgY2VsbERhdGEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjZWxsRGF0YSA9ICcnO1xuICAgICAgfVxuICAgICAgY29uc3QgY2VsbCA9IHsgdjogY2VsbERhdGEgfTtcbiAgICAgIGNlbGxSZWYgPSBYTFNYLnV0aWxzLmVuY29kZV9jZWxsKHsgYzogY29sSW5kZXgsIHI6IHJvd0luZGV4ICsgMSB9KTtcbiAgICAgIGlmICh0eXBlb2YgY2VsbC52ID09PSAnbnVtYmVyJykge1xuICAgICAgICBjZWxsLnQgPSAnbic7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRpZ2l0cykgJiYgTnVtYmVyKGRpZ2l0c1tyb3dJbmRleF1bY29sLnZhbHVlS2V5UGF0aC5qb2luKCcvJyldKSA+IC0xKSB7XG4gICAgICAgICAgY2VsbC56ID0gTnVtYmVyKFhMU1guU1NGLl90YWJsZVsyXSkudG9GaXhlZChkaWdpdHNbcm93SW5kZXhdW2NvbC52YWx1ZUtleVBhdGguam9pbignLycpXSk7XG4gICAgICAgIH0gZWxzZSBpZiAoTnVtYmVyKGRpZ2l0cykgPiAtMSkge1xuICAgICAgICAgIGNlbGwueiA9IE51bWJlcihYTFNYLlNTRi5fdGFibGVbMl0pLnRvRml4ZWQoZGlnaXRzKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY2VsbC52ID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgY2VsbC50ID0gJ2InO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2VsbC50ID0gJ3MnO1xuICAgICAgfVxuICAgICAgc2hlZXRbY2VsbFJlZl0gPSBjZWxsO1xuICAgIH0pO1xuICB9KTtcbiAgc2hlZXRbJyFjb2xzJ10gPSBzaGVldENvbHVtbnM7XG4gIHNoZWV0WychcmVmJ10gPSBYTFNYLnV0aWxzLmVuY29kZV9yYW5nZShyYW5nZSk7XG4gIHJldHVybiBzaGVldDtcbn07XG5cbi8qKlxuICogRXhwb3J0IGRhdGEgdG8gRXhjZWxcbiAqIElucHV0OlxuICogZGF0YSBpcyBhIExpc3Qgb2YgZGF0YSB0byBleHBvcnQsXG4gKiBjb2x1bW5zIGlzIGFuIGFycmF5IG9mIGNvbHVtbiBvYmplY3RzIHdpdGggdGhlIGtleXM6XG4gKiB7XG4gKiAgaGVhZGVyIDo6IHN0cmluZyBvciBlbGVtZW50LCBkZWZpbmVzIHRoZSBjb2x1bW4gbmFtZSxcbiAqICB2YWx1ZUtleVBhdGggOjogYXJyYXkgb2Ygc3RyaW5ncywgZGVmaW5lcyB0aGUgY29sdW1uIGlkLFxuICogIHdpZHRoIDo6IG51bWJlciwgd2lkdGggaW4gcGl4ZWxzLFxuICogIGRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwgOjogYm9vbCAob3B0aW9uYWwpLCBkaXNhYmxlIHZhbHVlUmVuZGVyIGNhbGxiYWNrIGZvciBleHBvcnQgdG8gRXhjZWwsXG4gKiAgICBpbnN0ZWFkIGV4cG9ydCB2YWx1ZSBkaXJlY3RseVxuICogIGhlYWRlclRleHQgOjogc3RyaW5nIChvcHRpb25hbCksIG5lZWRlZCBpZiAnaGVhZGVyJyBpcyBub3QgYSB0ZXh0LFxuICogIHZhbHVlUmVuZGVyIDo6IGZ1bmN0aW9uIChvcHRpb25hbCksIGRlZmluZXMgYSByZW5kZXIgZnVuY3Rpb24sXG4gKiAgdmFsdWVUeXBlRXhjZWwgOjogc3RyaW5nIChvcHRpb25hbCksIGRlZmluZXMgYSB2YWx1ZSB0eXBlIGZvciBFeGNlbCBpZiBkaWZmZXJzIGZyb20gVUlcbiAqIH0sXG4gKiBmaWxlTmFtZSBpcyBhIGZpbGUgbmFtZSBzdHJpbmcgKG9wdGlvbmFsKSxcbiAqIGRpZ2l0cyBpcyBhIG51bWJlciBvZiBkaWdpdHMgZm9yIGRlY2ltYWxzIGluIGFsbCB0YWJsZSBvciBhbiBhcnJheSBjb250YWluaW5nIGRpZ2l0c1xuICogZm9yIGNlbGxzIChvcHRpb25hbCksXG4gKiB2aXNpYmxlQ29sdW1ucyBpcyBhIGxpc3Qgb2YgdmlzaWJsZSBjb2x1bW5zIGluIGNhc2UgY29sdW1uIHNldHRpbmdzIGlzIHVzZWQgKG9wdGlvbmFsKS5cbiAqL1xuZXhwb3J0IGNvbnN0IGV4cG9ydFRvRXhjZWwgPSAoZGF0YSwgY29sdW1ucywgZmlsZU5hbWUgPSAnRXhwb3J0IEZyb20gT0MnLCBkaWdpdHMgPSBudWxsLCB2aXNpYmxlQ29sdW1ucyA9IG51bGwpID0+IHtcbiAgY29uc3Qgc2hlZXROYW1lID0gJ1NoZWV0MSc7XG4gIGNvbnN0IGV4cG9ydGVkQ29sdW1ucyA9IGdldENvbHVtbnMoY29sdW1ucywgdmlzaWJsZUNvbHVtbnMpO1xuICBjb25zdCBzaGVldCA9IGNyZWF0ZVdvcmtzaGVldChkYXRhLCBleHBvcnRlZENvbHVtbnMsIGRpZ2l0cyk7XG4gIGNvbnN0IGJvb2sgPSB7IFNoZWV0TmFtZXM6IFtzaGVldE5hbWVdLCBTaGVldHM6IHt9IH07XG4gIGJvb2suU2hlZXRzW3NoZWV0TmFtZV0gPSBzaGVldDtcbiAgY29uc3QgYm9va091dCA9IFhMU1gud3JpdGUoYm9vaywgeyBib29rVHlwZTogJ3hsc3gnLCBib29rU1NUOiB0cnVlLCB0eXBlOiAnYmluYXJ5JyB9KTtcbiAgLy8gY29uc29sZS5sb2coYm9vaywgYm9va091dCwgY29udmVydFN0cmluZ1RvQXJyYXlCdWZmZXIoYm9va091dCkpO1xuICBzYXZlQXMobmV3IEJsb2IoW2NvbnZlcnRTdHJpbmdUb0FycmF5QnVmZmVyKGJvb2tPdXQpXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KSwgYCR7ZmlsZU5hbWV9Lnhsc3hgKTtcbn07XG5cbi8qKlxuICogSW1wb3J0IGRhdGEgZnJvbSBFeGNlbFxuICogSW5wdXQ6XG4gKiBmaWxlcyBpcyBhbiBldmVudC50YXJnZXQuZmlsZXMgYXJyYXksXG4gKiBjYWxsYmFjayBpcyBvbkxvYWQgY2FsbGJhY2sgY2FsbGVkIGZyb20gYSBwYXJlbnQgY29tcG9uZW50LFxuICogYWxlcnRDYWxsYmFjayBpcyBhIGNhbGxiYWNrIGZvciBlcnJvciBhbGVydCAob3B0aW9uYWwpLlxuICovXG5leHBvcnQgY29uc3QgaW1wb3J0RnJvbUV4Y2VsID0gKGZpbGVzLCBjYWxsYmFjaywgYWxlcnRDYWxsYmFjayA9IG51bGwpID0+IHtcbiAgaWYgKGZpbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoYWxlcnRDYWxsYmFjayAmJiBmaWxlc1swXS50eXBlICE9PSAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQnKSB7XG4gICAgYWxlcnRDYWxsYmFjaygpO1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICByZWFkZXIub25sb2FkID0gY2FsbGJhY2s7XG4gIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihmaWxlc1swXSk7XG59O1xuXG4vKipcbiAqIENhbGxiYWNrIG9uIGxvYWQgb2YgRmlsZVJlYWRlciBmb3IgaW1wb3J0IG9wZXJhdGlvblxuICogSW5wdXQ6XG4gKiBlIGlzIGFuIGV2ZW50IG9iamVjdCxcbiAqIGNvbHVtbnMgaXMgYW4gYXJyYXkgb2YgY29sdW1uIG9iamVjdHMgd2l0aCB0aGUga2V5czpcbiAqIHtcbiAqICB2YWx1ZUtleVBhdGggOjogYXJyYXkgb2Ygc3RyaW5ncyxcbiAqICB2YWx1ZUV4Y2VsTWF0Y2ggOjogZnVuY3Rpb24gKG9wdGlvbmFsKSxcbiAqICBkZWZhdWx0VmFsdWUgOjogYW55LFxuICogfSxcbiAqIHZpc2libGVDb2x1bW5zIGlzIGEgbGlzdCBvZiB2aXNpYmxlIGNvbHVtbnMgaWRzIGluIGNhc2UgY29sdW1uIHNldHRpbmdzIGlzIHVzZWQgKG9wdGlvbmFsKS5cbiAqIE91dHB1dDpcbiAqIGFuIGFycmF5IG9mIGRhdGEuXG4gKi9cbmV4cG9ydCBjb25zdCBvbkxvYWRDYWxsYmFjayA9IChlLCBjb2x1bW5zLCB2aXNpYmxlQ29sdW1ucyA9IG51bGwpID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gY29udmVydEFycmF5QnVmZmVyVG9TdHJpbmcoZS50YXJnZXQucmVzdWx0KTtcbiAgY29uc3QgYm9vayA9IFhMU1gucmVhZChidG9hKHJlc3VsdCksIHsgdHlwZTogJ2Jhc2U2NCcgfSk7XG4gIGNvbnN0IHJhd0RhdGEgPVxuICAgIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihib29rLlNoZWV0c1tib29rLlNoZWV0TmFtZXNbMF1dLCB7IGhlYWRlcjogMSwgcmF3OiB0cnVlIH0pO1xuICBpZiAoQXJyYXkuaXNBcnJheShyYXdEYXRhKSAmJiByYXdEYXRhLmxlbmd0aCA8IDIpIHtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgY29uc3QgaW1wb3J0ZWRDb2x1bW5zID0gZ2V0Q29sdW1ucyhjb2x1bW5zLCB2aXNpYmxlQ29sdW1ucyk7XG4gIGNvbnN0IGRhdGEgPSBbXTtcbiAgcmF3RGF0YS5mb3JFYWNoKChyb3csIHJvd0luZGV4KSA9PiB7XG4gICAgLy8gc2tpcCB0aGUgaGVhZGVyXG4gICAgaWYgKHJvd0luZGV4ID49IDEpIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSB7fTtcbiAgICAgIHJvdy5mb3JFYWNoKChjZWxsLCBjZWxsSW5kZXgpID0+IHtcbiAgICAgICAgaWYgKGNlbGxJbmRleCA8IGltcG9ydGVkQ29sdW1ucy5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGltcG9ydGVkQ29sdW1uc1tjZWxsSW5kZXhdLnZhbHVlRXhjZWxNYXRjaCAhPT0gdW5kZWZpbmVkID9cbiAgICAgICAgICAgIGltcG9ydGVkQ29sdW1uc1tjZWxsSW5kZXhdLnZhbHVlRXhjZWxNYXRjaChjZWxsKSA6IGNlbGw7XG4gICAgICAgICAgaXRlbVtpbXBvcnRlZENvbHVtbnNbY2VsbEluZGV4XS52YWx1ZUtleVBhdGhbMF1dID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaW1wb3J0ZWRDb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xuICAgICAgICBpZiAoY29sdW1uLmRlZmF1bHRWYWx1ZSAhPT0gdW5kZWZpbmVkICYmIGl0ZW1bY29sdW1uLnZhbHVlS2V5UGF0aFswXV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGl0ZW1bY29sdW1uLnZhbHVlS2V5UGF0aFswXV0gPSBjb2x1bW4uZGVmYXVsdFZhbHVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGRhdGEucHVzaChpdGVtKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gZGF0YTtcbn07XG4iXX0=