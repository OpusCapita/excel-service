var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

/* eslint-disable consistent-return */
/* eslint-disable no-plusplus */
/* eslint-disable no-bitwise */
import XLSX from 'xlsx-styles';
import saveAs from 'file-saver';

var writeOptions = {
  type: 'binary',
  bookSST: false,
  bookType: 'xlsx',
  showGridLines: false
};

var EXCEL_MAX_ROW_COUNT = 1048576;
var EXCEL_MAX_COL_COUNT = 16384;

// https://www.npmjs.com/package/xlsx-styles#cell-styles
var borderStyle = { style: 'thin', color: { rgb: 'CCCCCC' } };
var border = {
  border: {
    top: borderStyle,
    bottom: borderStyle,
    left: borderStyle,
    right: borderStyle
  }
};

var createColumnTitles = function createColumnTitles() {
  var columns = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var colOffset = arguments[1];
  var headerStyle = arguments[2];
  var noBorders = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
  var cells = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : [];
  var rowIndex = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : 0;

  var row = [];
  columns.forEach(function (column, colIndex) {
    var cellIndex = colOffset + colIndex;
    if (Array.isArray(column)) {
      return createColumnTitles(column, colOffset, headerStyle, noBorders, cells, colIndex);
    }
    var cellValue = (column || {}).header || '';
    var cell = { v: cellValue, t: 's', s: headerStyle };
    if (!noBorders) {
      cell.s = _extends({}, cell.s, border);
    }
    var cellRef = XLSX.utils.encode_cell({ c: cellIndex, r: rowIndex });
    var cellData = { cell: cell, cellRef: cellRef };
    if (column && column.merge > 1) {
      cellData.merge = {
        s: {
          c: cellIndex,
          r: rowIndex
        },
        e: {
          c: cellIndex + (column.merge - 1),
          r: rowIndex
        }
      };
    }
    var upperCell = rowIndex > 0 ? cells[rowIndex - 1][colIndex] : undefined;
    if (column && column.valueKeyPath) {
      cellData.valueKeyPath = column.valueKeyPath;
      cellData.valueRender = column.valueRender;
      cellData.disableValueRenderInExcel = column.disableValueRenderInExcel;
      if (column.valueOptions && column.valueOptions.multiplier) {
        cellData.multiplier = column.valueOptions.multiplier;
      }
    } else if (rowIndex > 0) {
      cellData.valueKeyPath = upperCell.valueKeyPath;
    }
    var wch = upperCell && !upperCell.merge && upperCell.wch > cellValue.length ? upperCell.wch : cellValue.length;
    cellData.wch = wch;
    row.push(cellData);
  });
  if (row.length > 0) {
    cells.push(row);
  }
  return cells;
};

var createDataSheet = function createDataSheet(exportData) {
  var columns = exportData.columns,
      _exportData$data = exportData.data,
      data = _exportData$data === undefined ? [] : _exportData$data,
      dataStyle = exportData.dataStyle,
      formatter = exportData.formatter,
      headerStyle = exportData.headerStyle,
      noBorders = exportData.noBorders,
      rows = exportData.rows;

  var worksheet = {};
  var colOffset = rows && rows.length > 0 ? 1 : 0;
  var columnTitles = createColumnTitles(columns, colOffset, headerStyle, noBorders);
  var rowOffset = columnTitles.length;

  var merges = [];
  if (rows && rows.length > 0 && rowOffset > 1) {
    merges.push({ s: { c: 0, r: 0 }, e: { c: 0, r: rowOffset - 1 } });
  }

  var cols = [];

  columnTitles.forEach(function (columnRow) {
    return columnRow.forEach(function (columnTitle, colIndex) {
      worksheet[columnTitle.cellRef] = columnTitle.cell;
      if (columnTitle.merge) {
        merges.push(columnTitle.merge);
      }
      cols[colIndex] = { wch: columnTitle.wch };
    });
  });

  if (rows) {
    var wch = 0;
    rows.forEach(function (row, rowIndex) {
      var cellRowIndex = rowIndex + rowOffset;
      var cellRef = XLSX.utils.encode_cell({ c: 0, r: cellRowIndex });
      var title = row.header;
      var width = title ? title.length : 0;
      wch = wch < width ? width : wch;
      var cell = { v: title, t: 's', s: headerStyle };
      if (!noBorders) {
        cell.s = _extends({}, cell.s, border);
      }
      worksheet[cellRef] = cell;
    });
    cols.unshift({ wch: wch });
  }
  worksheet['!cols'] = cols;
  worksheet['!merges'] = merges;

  var createCell = function createCell(value, colIndex, rowIndex) {
    var cellRowIndex = rowIndex + rowOffset;
    var cellColIndex = colIndex + colOffset;
    var cell = { v: value, s: dataStyle };
    if (!noBorders) {
      cell.s = _extends({}, cell.s, border);
    }
    var cellRef = XLSX.utils.encode_cell({ c: cellColIndex, r: cellRowIndex });
    switch (typeof value === 'undefined' ? 'undefined' : _typeof(value)) {
      case 'number':
        {
          cell.t = 'n';
          break;
        }
      case 'boolean':
        {
          cell.t = 'b';
          break;
        }
      default:
        {
          cell.t = 's';
          break;
        }
    }
    worksheet[cellRef] = cell;
  };

  var formatCell = function formatCell(value, column, row) {
    var disableValueRenderInExcel = column.disableValueRenderInExcel,
        multiplier = column.multiplier,
        valueRender = column.valueRender;

    var cellValue = multiplier && typeof value === 'number' ? multiplier * value : value;
    if (valueRender && !disableValueRenderInExcel) {
      cellValue = valueRender(row);
    } else if (formatter) {
      cellValue = formatter(cellValue);
    }
    return cellValue;
  };

  var detailedColumns = columnTitles.length > 0 ? columnTitles[rowOffset - 1] : [];
  var endColumnIndex = 0;
  if (detailedColumns.length > 0) {
    data.forEach(function (row, rowIndex) {
      detailedColumns.forEach(function (column, colIndex) {
        var cellValue = formatCell(row.getIn ? row.getIn(column.valueKeyPath) : row[column.valueKeyPath], column, row);
        createCell(cellValue, colIndex, rowIndex);
      });
    });
    endColumnIndex = detailedColumns.length + colOffset;
  } else {
    data.forEach(function (row, rowIndex) {
      row.forEach(function (column, colIndex) {
        var cellValue = formatCell(column.value, column, row);
        createCell(cellValue, colIndex, rowIndex);
        var currentColIndex = colIndex + colOffset;
        endColumnIndex = endColumnIndex < currentColIndex ? currentColIndex : endColumnIndex;
        cols.push({ wch: 50 });
      });
    });
  }
  var endRowIndex = (data.length || data.size) + rowOffset;
  var range = {
    s: {
      c: 0,
      r: 0
    },
    e: {
      c: endColumnIndex,
      r: endRowIndex
    }
  };
  if (range.e.c < EXCEL_MAX_COL_COUNT && range.e.r < EXCEL_MAX_ROW_COUNT) {
    worksheet['!ref'] = XLSX.utils.encode_range(range);
  }

  return worksheet;
};

export default (function (sheets, fileName) {
  var workbook = { SheetNames: [], Sheets: {} };

  sheets.forEach(function (sheet, index) {
    var sheetName = sheet.name || 'Sheet ' + (index + 1);
    workbook.SheetNames.push(sheetName);
    var wsSheet = createDataSheet(sheet);
    workbook.Sheets[sheetName] = wsSheet;
  });

  var wbout = XLSX.write(workbook, writeOptions);
  function s2ab(s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for (var i = 0; i !== s.length; ++i) {
      view[i] = s.charCodeAt(i) & 0xFF;
    }
    return buf;
  }

  /* the saveAs call downloads a file on the local machine */
  saveAs(new Blob([s2ab(wbout)], { type: '' }), fileName + '.xlsx');
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdHlsZWQtZXhjZWwtZXhwb3J0LmpzIl0sIm5hbWVzIjpbIlhMU1giLCJzYXZlQXMiLCJ3cml0ZU9wdGlvbnMiLCJ0eXBlIiwiYm9va1NTVCIsImJvb2tUeXBlIiwic2hvd0dyaWRMaW5lcyIsIkVYQ0VMX01BWF9ST1dfQ09VTlQiLCJFWENFTF9NQVhfQ09MX0NPVU5UIiwiYm9yZGVyU3R5bGUiLCJzdHlsZSIsImNvbG9yIiwicmdiIiwiYm9yZGVyIiwidG9wIiwiYm90dG9tIiwibGVmdCIsInJpZ2h0IiwiY3JlYXRlQ29sdW1uVGl0bGVzIiwiY29sdW1ucyIsImNvbE9mZnNldCIsImhlYWRlclN0eWxlIiwibm9Cb3JkZXJzIiwiY2VsbHMiLCJyb3dJbmRleCIsInJvdyIsImZvckVhY2giLCJjb2x1bW4iLCJjb2xJbmRleCIsImNlbGxJbmRleCIsIkFycmF5IiwiaXNBcnJheSIsImNlbGxWYWx1ZSIsImhlYWRlciIsImNlbGwiLCJ2IiwidCIsInMiLCJjZWxsUmVmIiwidXRpbHMiLCJlbmNvZGVfY2VsbCIsImMiLCJyIiwiY2VsbERhdGEiLCJtZXJnZSIsImUiLCJ1cHBlckNlbGwiLCJ1bmRlZmluZWQiLCJ2YWx1ZUtleVBhdGgiLCJ2YWx1ZVJlbmRlciIsImRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwiLCJ2YWx1ZU9wdGlvbnMiLCJtdWx0aXBsaWVyIiwid2NoIiwibGVuZ3RoIiwicHVzaCIsImNyZWF0ZURhdGFTaGVldCIsImV4cG9ydERhdGEiLCJkYXRhIiwiZGF0YVN0eWxlIiwiZm9ybWF0dGVyIiwicm93cyIsIndvcmtzaGVldCIsImNvbHVtblRpdGxlcyIsInJvd09mZnNldCIsIm1lcmdlcyIsImNvbHMiLCJjb2x1bW5Sb3ciLCJjb2x1bW5UaXRsZSIsImNlbGxSb3dJbmRleCIsInRpdGxlIiwid2lkdGgiLCJ1bnNoaWZ0IiwiY3JlYXRlQ2VsbCIsInZhbHVlIiwiY2VsbENvbEluZGV4IiwiZm9ybWF0Q2VsbCIsImRldGFpbGVkQ29sdW1ucyIsImVuZENvbHVtbkluZGV4IiwiZ2V0SW4iLCJjdXJyZW50Q29sSW5kZXgiLCJlbmRSb3dJbmRleCIsInNpemUiLCJyYW5nZSIsImVuY29kZV9yYW5nZSIsInNoZWV0cyIsImZpbGVOYW1lIiwid29ya2Jvb2siLCJTaGVldE5hbWVzIiwiU2hlZXRzIiwic2hlZXQiLCJpbmRleCIsInNoZWV0TmFtZSIsIm5hbWUiLCJ3c1NoZWV0Iiwid2JvdXQiLCJ3cml0ZSIsInMyYWIiLCJidWYiLCJBcnJheUJ1ZmZlciIsInZpZXciLCJVaW50OEFycmF5IiwiaSIsImNoYXJDb2RlQXQiLCJCbG9iIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUE7QUFDQTtBQUNBO0FBQ0EsT0FBT0EsSUFBUCxNQUFpQixhQUFqQjtBQUNBLE9BQU9DLE1BQVAsTUFBbUIsWUFBbkI7O0FBRUEsSUFBTUMsZUFBZTtBQUNuQkMsUUFBTSxRQURhO0FBRW5CQyxXQUFTLEtBRlU7QUFHbkJDLFlBQVUsTUFIUztBQUluQkMsaUJBQWU7QUFKSSxDQUFyQjs7QUFPQSxJQUFNQyxzQkFBc0IsT0FBNUI7QUFDQSxJQUFNQyxzQkFBc0IsS0FBNUI7O0FBRUE7QUFDQSxJQUFNQyxjQUFjLEVBQUVDLE9BQU8sTUFBVCxFQUFpQkMsT0FBTyxFQUFFQyxLQUFLLFFBQVAsRUFBeEIsRUFBcEI7QUFDQSxJQUFNQyxTQUFTO0FBQ2JBLFVBQVE7QUFDTkMsU0FBS0wsV0FEQztBQUVOTSxZQUFRTixXQUZGO0FBR05PLFVBQU1QLFdBSEE7QUFJTlEsV0FBT1I7QUFKRDtBQURLLENBQWY7O0FBU0EsSUFBTVMscUJBQXFCLFNBQXJCQSxrQkFBcUIsR0FPdEI7QUFBQSxNQU5IQyxPQU1HLHVFQU5PLEVBTVA7QUFBQSxNQUxIQyxTQUtHO0FBQUEsTUFKSEMsV0FJRztBQUFBLE1BSEhDLFNBR0csdUVBSFMsS0FHVDtBQUFBLE1BRkhDLEtBRUcsdUVBRkssRUFFTDtBQUFBLE1BREhDLFFBQ0csdUVBRFEsQ0FDUjs7QUFDSCxNQUFNQyxNQUFNLEVBQVo7QUFDQU4s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LENBQUwsSUFBVWpFLEVBQUVrRSxVQUFGLENBQWFELENBQWIsSUFBa0IsSUFBNUI7QUFDRDtBQUNELFdBQU9KLEdBQVA7QUFDRDs7QUFFRDtBQUNBakcsU0FBTyxJQUFJdUcsSUFBSixDQUFTLENBQUNQLEtBQUtGLEtBQUwsQ0FBRCxDQUFULEVBQXdCLEVBQUU1RixNQUFNLEVBQVIsRUFBeEIsQ0FBUCxFQUFpRG1GLFFBQWpEO0FBQ0QsQ0F0QkQiLCJmaWxlIjoic3R5bGVkLWV4Y2VsLWV4cG9ydC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIGNvbnNpc3RlbnQtcmV0dXJuICovXG4vKiBlc2xpbnQtZGlzYWJsZSBuby1wbHVzcGx1cyAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tYml0d2lzZSAqL1xuaW1wb3J0IFhMU1ggZnJvbSAneGxzeC1zdHlsZXMnO1xuaW1wb3J0IHNhdmVBcyBmcm9tICdmaWxlLXNhdmVyJztcblxuY29uc3Qgd3JpdGVPcHRpb25zID0ge1xuICB0eXBlOiAnYmluYXJ5JyxcbiAgYm9va1NTVDogZmFsc2UsXG4gIGJvb2tUeXBlOiAneGxzeCcsXG4gIHNob3dHcmlkTGluZXM6IGZhbHNlLFxufTtcblxuY29uc3QgRVhDRUxfTUFYX1JPV19DT1VOVCA9IDEwNDg1NzY7XG5jb25zdCBFWENFTF9NQVhfQ09MX0NPVU5UID0gMTYzODQ7XG5cbi8vIGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL3hsc3gtc3R5bGVzI2NlbGwtc3R5bGVzXG5jb25zdCBib3JkZXJTdHlsZSA9IHsgc3R5bGU6ICd0aGluJywgY29sb3I6IHsgcmdiOiAnQ0NDQ0NDJyB9IH07XG5jb25zdCBib3JkZXIgPSB7XG4gIGJvcmRlcjoge1xuICAgIHRvcDogYm9yZGVyU3R5bGUsXG4gICAgYm90dG9tOiBib3JkZXJTdHlsZSxcbiAgICBsZWZ0OiBib3JkZXJTdHlsZSxcbiAgICByaWdodDogYm9yZGVyU3R5bGUsXG4gIH0sXG59O1xuXG5jb25zdCBjcmVhdGVDb2x1bW5UaXRsZXMgPSAoXG4gIGNvbHVtbnMgPSBbXSxcbiAgY29sT2Zmc2V0LFxuICBoZWFkZXJTdHlsZSxcbiAgbm9Cb3JkZXJzID0gZmFsc2UsXG4gIGNlbGxzID0gW10sXG4gIHJvd0luZGV4ID0gMCxcbikgPT4ge1xuICBjb25zdCByb3cgPSBbXTtcbiAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4sIGNvbEluZGV4KSA9PiB7XG4gICAgY29uc3QgY2VsbEluZGV4ID0gY29sT2Zmc2V0ICsgY29sSW5kZXg7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoY29sdW1uKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUNvbHVtblRpdGxlcyhjb2x1bW4sIGNvbE9mZnNldCwgaGVhZGVyU3R5bGUsIG5vQm9yZGVycywgY2VsbHMsIGNvbEluZGV4KTtcbiAgICB9XG4gICAgY29uc3QgY2VsbFZhbHVlID0gKGNvbHVtbiB8fCB7fSkuaGVhZGVyIHx8ICcnO1xuICAgIGNvbnN0IGNlbGwgPSB7IHY6IGNlbGxWYWx1ZSwgdDogJ3MnLCBzOiBoZWFkZXJTdHlsZSB9O1xuICAgIGlmICghbm9Cb3JkZXJzKSB7XG4gICAgICBjZWxsLnMgPSB7IC4uLmNlbGwucywgLi4uYm9yZGVyIH07XG4gICAgfVxuICAgIGNvbnN0IGNlbGxSZWYgPSBYTFNYLnV0aWxzLmVuY29kZV9jZWxsKHsgYzogY2VsbEluZGV4LCByOiByb3dJbmRleCB9KTtcbiAgICBjb25zdCBjZWxsRGF0YSA9IHsgY2VsbCwgY2VsbFJlZiB9O1xuICAgIGlmIChjb2x1bW4gJiYgY29sdW1uLm1lcmdlID4gMSkge1xuICAgICAgY2VsbERhdGEubWVyZ2UgPSB7XG4gICAgICAgIHM6IHtcbiAgICAgICAgICBjOiBjZWxsSW5kZXgsXG4gICAgICAgICAgcjogcm93SW5kZXgsXG4gICAgICAgIH0sXG4gICAgICAgIGU6IHtcbiAgICAgICAgICBjOiBjZWxsSW5kZXggKyAoY29sdW1uLm1lcmdlIC0gMSksXG4gICAgICAgICAgcjogcm93SW5kZXgsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH1cbiAgICBjb25zdCB1cHBlckNlbGwgPSByb3dJbmRleCA+IDAgPyBjZWxsc1tyb3dJbmRleCAtIDFdW2NvbEluZGV4XSA6IHVuZGVmaW5lZDtcbiAgICBpZiAoY29sdW1uICYmIGNvbHVtbi52YWx1ZUtleVBhdGgpIHtcbiAgICAgIGNlbGxEYXRhLnZhbHVlS2V5UGF0aCA9IGNvbHVtbi52YWx1ZUtleVBhdGg7XG4gICAgICBjZWxsRGF0YS52YWx1ZVJlbmRlciA9IGNvbHVtbi52YWx1ZVJlbmRlcjtcbiAgICAgIGNlbGxEYXRhLmRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwgPSBjb2x1bW4uZGlzYWJsZVZhbHVlUmVuZGVySW5FeGNlbDtcbiAgICAgIGlmIChjb2x1bW4udmFsdWVPcHRpb25zICYmIGNvbHVtbi52YWx1ZU9wdGlvbnMubXVsdGlwbGllcikge1xuICAgICAgICBjZWxsRGF0YS5tdWx0aXBsaWVyID0gY29sdW1uLnZhbHVlT3B0aW9ucy5tdWx0aXBsaWVyO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocm93SW5kZXggPiAwKSB7XG4gICAgICBjZWxsRGF0YS52YWx1ZUtleVBhdGggPSB1cHBlckNlbGwudmFsdWVLZXlQYXRoO1xuICAgIH1cbiAgICBjb25zdCB3Y2ggPSB1cHBlckNlbGwgJiYgIXVwcGVyQ2VsbC5tZXJnZSAmJiB1cHBlckNlbGwud2NoID4gY2VsbFZhbHVlLmxlbmd0aFxuICAgICAgPyB1cHBlckNlbGwud2NoXG4gICAgICA6IGNlbGxWYWx1ZS5sZW5ndGg7XG4gICAgY2VsbERhdGEud2NoID0gd2NoO1xuICAgIHJvdy5wdXNoKGNlbGxEYXRhKTtcbiAgfSk7XG4gIGlmIChyb3cubGVuZ3RoID4gMCkge1xuICAgIGNlbGxzLnB1c2gocm93KTtcbiAgfVxuICByZXR1cm4gY2VsbHM7XG59O1xuXG5jb25zdCBjcmVhdGVEYXRhU2hlZXQgPSAoZXhwb3J0RGF0YSkgPT4ge1xuICBjb25zdCB7XG4gICAgY29sdW1ucyxcbiAgICBkYXRhID0gW10sXG4gICAgZGF0YVN0eWxlLFxuICAgIGZvcm1hdHRlcixcbiAgICBoZWFkZXJTdHlsZSxcbiAgICBub0JvcmRlcnMsXG4gICAgcm93cyxcbiAgfSA9IGV4cG9ydERhdGE7XG4gIGNvbnN0IHdvcmtzaGVldCA9IHt9O1xuICBjb25zdCBjb2xPZmZzZXQgPSByb3dzICYmIHJvd3MubGVuZ3RoID4gMCA/IDEgOiAwO1xuICBjb25zdCBjb2x1bW5UaXRsZXMgPSBjcmVhdGVDb2x1bW5UaXRsZXMoY29sdW1ucywgY29sT2Zmc2V0LCBoZWFkZXJTdHlsZSwgbm9Cb3JkZXJzKTtcbiAgY29uc3Qgcm93T2Zmc2V0ID0gY29sdW1uVGl0bGVzLmxlbmd0aDtcblxuICBjb25zdCBtZXJnZXMgPSBbXTtcbiAgaWYgKHJvd3MgJiYgcm93cy5sZW5ndGggPiAwICYmIHJvd09mZnNldCA+IDEpIHtcbiAgICBtZXJnZXMucHVzaCh7IHM6IHsgYzogMCwgcjogMCB9LCBlOiB7IGM6IDAsIHI6IHJvd09mZnNldCAtIDEgfSB9KTtcbiAgfVxuXG4gIGNvbnN0IGNvbHMgPSBbXTtcblxuICBjb2x1bW5UaXRsZXMuZm9yRWFjaChjb2x1bW5Sb3cgPT4gKFxuICAgIGNvbHVtblJvdy5mb3JFYWNoKChjb2x1bW5UaXRsZSwgY29sSW5kZXgpID0+IHtcbiAgICAgIHdvcmtzaGVldFtjb2x1bW5UaXRsZS5jZWxsUmVmXSA9IGNvbHVtblRpdGxlLmNlbGw7XG4gICAgICBpZiAoY29sdW1uVGl0bGUubWVyZ2UpIHtcbiAgICAgICAgbWVyZ2VzLnB1c2goY29sdW1uVGl0bGUubWVyZ2UpO1xuICAgICAgfVxuICAgICAgY29sc1tjb2xJbmRleF0gPSB7IHdjaDogY29sdW1uVGl0bGUud2NoIH07XG4gICAgfSlcbiAgKSk7XG5cbiAgaWYgKHJvd3MpIHtcbiAgICBsZXQgd2NoID0gMDtcbiAgICByb3dzLmZvckVhY2goKHJvdywgcm93SW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGNlbGxSb3dJbmRleCA9IHJvd0luZGV4ICsgcm93T2Zmc2V0O1xuICAgICAgY29uc3QgY2VsbFJlZiA9IFhMU1gudXRpbHMuZW5jb2RlX2NlbGwoeyBjOiAwLCByOiBjZWxsUm93SW5kZXggfSk7XG4gICAgICBjb25zdCB0aXRsZSA9IHJvdy5oZWFkZXI7XG4gICAgICBjb25zdCB3aWR0aCA9IHRpdGxlID8gdGl0bGUubGVuZ3RoIDogMDtcbiAgICAgIHdjaCA9IHdjaCA8IHdpZHRoID8gd2lkdGggOiB3Y2g7XG4gICAgICBjb25zdCBjZWxsID0geyB2OiB0aXRsZSwgdDogJ3MnLCBzOiBoZWFkZXJTdHlsZSB9O1xuICAgICAgaWYgKCFub0JvcmRlcnMpIHtcbiAgICAgICAgY2VsbC5zID0geyAuLi5jZWxsLnMsIC4uLmJvcmRlciB9O1xuICAgICAgfVxuICAgICAgd29ya3NoZWV0W2NlbGxSZWZdID0gY2VsbDtcbiAgICB9KTtcbiAgICBjb2xzLnVuc2hpZnQoeyB3Y2ggfSk7XG4gIH1cbiAgd29ya3NoZWV0WychY29scyddID0gY29scztcbiAgd29ya3NoZWV0WychbWVyZ2VzJ10gPSBtZXJnZXM7XG5cbiAgY29uc3QgY3JlYXRlQ2VsbCA9ICh2YWx1ZSwgY29sSW5kZXgsIHJvd0luZGV4KSA9PiB7XG4gICAgY29uc3QgY2VsbFJvd0luZGV4ID0gcm93SW5kZXggKyByb3dPZmZzZXQ7XG4gICAgY29uc3QgY2VsbENvbEluZGV4ID0gY29sSW5kZXggKyBjb2xPZmZzZXQ7XG4gICAgY29uc3QgY2VsbCA9IHsgdjogdmFsdWUsIHM6IGRhdGFTdHlsZSB9O1xuICAgIGlmICghbm9Cb3JkZXJzKSB7XG4gICAgICBjZWxsLnMgPSB7IC4uLmNlbGwucywgLi4uYm9yZGVyIH07XG4gICAgfVxuICAgIGNvbnN0IGNlbGxSZWYgPSBYTFNYLnV0aWxzLmVuY29kZV9jZWxsKHsgYzogY2VsbENvbEluZGV4LCByOiBjZWxsUm93SW5kZXggfSk7XG4gICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHtcbiAgICAgIGNhc2UgKCdudW1iZXInKToge1xuICAgICAgICBjZWxsLnQgPSAnbic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAoJ2Jvb2xlYW4nKToge1xuICAgICAgICBjZWxsLnQgPSAnYic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICBjZWxsLnQgPSAncyc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICB3b3Jrc2hlZXRbY2VsbFJlZl0gPSBjZWxsO1xuICB9O1xuXG4gIGNvbnN0IGZvcm1hdENlbGwgPSAodmFsdWUsIGNvbHVtbiwgcm93KSA9PiB7XG4gICAgY29uc3QgeyBkaXNhYmxlVmFsdWVSZW5kZXJJbkV4Y2VsLCBtdWx0aXBsaWVyLCB2YWx1ZVJlbmRlciB9ID0gY29sdW1uO1xuICAgIGxldCBjZWxsVmFsdWUgPSBtdWx0aXBsaWVyICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBtdWx0aXBsaWVyICogdmFsdWUgOiB2YWx1ZTtcbiAgICBpZiAodmFsdWVSZW5kZXIgJiYgIWRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwpIHtcbiAgICAgIGNlbGxWYWx1ZSA9IHZhbHVlUmVuZGVyKHJvdyk7XG4gICAgfSBlbHNlIGlmIChmb3JtYXR0ZXIpIHtcbiAgICAgIGNlbGxWYWx1ZSA9IGZvcm1hdHRlcihjZWxsVmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gY2VsbFZhbHVlO1xuICB9O1xuXG4gIGNvbnN0IGRldGFpbGVkQ29sdW1ucyA9IGNvbHVtblRpdGxlcy5sZW5ndGggPiAwID8gY29sdW1uVGl0bGVzW3Jvd09mZnNldCAtIDFdIDogW107XG4gIGxldCBlbmRDb2x1bW5JbmRleCA9IDA7XG4gIGlmIChkZXRhaWxlZENvbHVtbnMubGVuZ3RoID4gMCkge1xuICAgIGRhdGEuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgZGV0YWlsZWRDb2x1bW5zLmZvckVhY2goKGNvbHVtbiwgY29sSW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgY2VsbFZhbHVlID0gZm9ybWF0Q2VsbChyb3cuZ2V0SW5cbiAgICAgICAgICA/IHJvdy5nZXRJbihjb2x1bW4udmFsdWVLZXlQYXRoKVxuICAgICAgICAgIDogcm93W2NvbHVtbi52YWx1ZUtleVBhdGhdLCBjb2x1bW4sIHJvdyk7XG4gICAgICAgIGNyZWF0ZUNlbGwoY2VsbFZhbHVlLCBjb2xJbmRleCwgcm93SW5kZXgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZW5kQ29sdW1uSW5kZXggPSBkZXRhaWxlZENvbHVtbnMubGVuZ3RoICsgY29sT2Zmc2V0O1xuICB9IGVsc2Uge1xuICAgIGRhdGEuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgcm93LmZvckVhY2goKGNvbHVtbiwgY29sSW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgY2VsbFZhbHVlID0gZm9ybWF0Q2VsbChjb2x1bW4udmFsdWUsIGNvbHVtbiwgcm93KTtcbiAgICAgICAgY3JlYXRlQ2VsbChjZWxsVmFsdWUsIGNvbEluZGV4LCByb3dJbmRleCk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb2xJbmRleCA9IGNvbEluZGV4ICsgY29sT2Zmc2V0O1xuICAgICAgICBlbmRDb2x1bW5JbmRleCA9IGVuZENvbHVtbkluZGV4IDwgY3VycmVudENvbEluZGV4ID8gY3VycmVudENvbEluZGV4IDogZW5kQ29sdW1uSW5kZXg7XG4gICAgICAgIGNvbHMucHVzaCh7IHdjaDogNTAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBjb25zdCBlbmRSb3dJbmRleCA9IChkYXRhLmxlbmd0aCB8fCBkYXRhLnNpemUpICsgcm93T2Zmc2V0O1xuICBjb25zdCByYW5nZSA9IHtcbiAgICBzOiB7XG4gICAgICBjOiAwLFxuICAgICAgcjogMCxcbiAgICB9LFxuICAgIGU6IHtcbiAgICAgIGM6IGVuZENvbHVtbkluZGV4LFxuICAgICAgcjogZW5kUm93SW5kZXgsXG4gICAgfSxcbiAgfTtcbiAgaWYgKHJhbmdlLmUuYyA8IEVYQ0VMX01BWF9DT0xfQ09VTlQgJiYgcmFuZ2UuZS5yIDwgRVhDRUxfTUFYX1JPV19DT1VOVCkge1xuICAgIHdvcmtzaGVldFsnIXJlZiddID0gWExTWC51dGlscy5lbmNvZGVfcmFuZ2UocmFuZ2UpO1xuICB9XG5cbiAgcmV0dXJuIHdvcmtzaGVldDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IChzaGVldHMsIGZpbGVOYW1lKSA9PiB7XG4gIGNvbnN0IHdvcmtib29rID0geyBTaGVldE5hbWVzOiBbXSwgU2hlZXRzOiB7fSB9O1xuXG4gIHNoZWV0cy5mb3JFYWNoKChzaGVldCwgaW5kZXgpID0+IHtcbiAgICBjb25zdCBzaGVldE5hbWUgPSBzaGVldC5uYW1lIHx8IGBTaGVldCAke2luZGV4ICsgMX1gO1xuICAgIHdvcmtib29rLlNoZWV0TmFtZXMucHVzaChzaGVldE5hbWUpO1xuICAgIGNvbnN0IHdzU2hlZXQgPSBjcmVhdGVEYXRhU2hlZXQoc2hlZXQpO1xuICAgIHdvcmtib29rLlNoZWV0c1tzaGVldE5hbWVdID0gd3NTaGVldDtcbiAgfSk7XG5cbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKHdvcmtib29rLCB3cml0ZU9wdGlvbnMpO1xuICBmdW5jdGlvbiBzMmFiKHMpIHtcbiAgICBjb25zdCBidWYgPSBuZXcgQXJyYXlCdWZmZXIocy5sZW5ndGgpO1xuICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBzLmxlbmd0aDsgKytpKSB7XG4gICAgICB2aWV3W2ldID0gcy5jaGFyQ29kZUF0KGkpICYgMHhGRjtcbiAgICB9XG4gICAgcmV0dXJuIGJ1ZjtcbiAgfVxuXG4gIC8qIHRoZSBzYXZlQXMgY2FsbCBkb3dubG9hZHMgYSBmaWxlIG9uIHRoZSBsb2NhbCBtYWNoaW5lICovXG4gIHNhdmVBcyhuZXcgQmxvYihbczJhYih3Ym91dCldLCB7IHR5cGU6ICcnIH0pLCBgJHtmaWxlTmFtZX0ueGxzeGApO1xufTtcbiJdfQ==