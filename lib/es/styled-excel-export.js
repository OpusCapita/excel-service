var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

/* eslint-disable consistent-return */
/* eslint-disable no-plusplus */
/* eslint-disable no-bitwise */
import XLSX from 'xlsx-styles';
import saveAs from 'file-saver';

var writeOptions = {
  type: 'binary',
  bookSST: false,
  bookType: 'xlsx',
  showGridLines: false
};

var EXCEL_MAX_ROW_COUNT = 1048576;
var EXCEL_MAX_COL_COUNT = 16384;

// https://www.npmjs.com/package/xlsx-styles#cell-styles
var borderStyle = { style: 'thin', color: { rgb: 'CCCCCC' } };
var border = {
  border: {
    top: borderStyle,
    bottom: borderStyle,
    left: borderStyle,
    right: borderStyle
  }
};

var createColumnTitles = function createColumnTitles() {
  var columns = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var colOffset = arguments[1];
  var headerStyle = arguments[2];
  var noBorders = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
  var cells = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : [];
  var rowIndex = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : 0;

  var row = [];
  columns.forEach(function (column, colIndex) {
    var cellIndex = colOffset + colIndex;
    if (Array.isArray(column)) {
      return createColumnTitles(column, colOffset, headerStyle, noBorders, cells, colIndex);
    }
    var cellValue = (column || {}).header || '';
    var cell = { v: cellValue, t: 's', s: headerStyle };
    if (!noBorders) {
      cell.s = _extends({}, cell.s, border);
    }
    var cellRef = XLSX.utils.encode_cell({ c: cellIndex, r: rowIndex });
    var cellData = { cell: cell, cellRef: cellRef };
    if (column && column.merge > 1) {
      cellData.merge = {
        s: {
          c: cellIndex,
          r: rowIndex
        },
        e: {
          c: cellIndex + (column.merge - 1),
          r: rowIndex
        }
      };
    }
    var upperCell = rowIndex > 0 ? cells[rowIndex - 1][colIndex] : undefined;
    if (column && column.valueKeyPath) {
      cellData.valueKeyPath = column.valueKeyPath;
      cellData.valueRender = column.valueRender;
      cellData.disableValueRenderInExcel = column.disableValueRenderInExcel;
    } else if (rowIndex > 0) {
      cellData.valueKeyPath = upperCell.valueKeyPath;
    }
    var wch = upperCell && !upperCell.merge && upperCell.wch > cellValue.length ? upperCell.wch : cellValue.length;
    cellData.wch = wch;
    row.push(cellData);
  });
  if (row.length > 0) {
    cells.push(row);
  }
  return cells;
};

var createDataSheet = function createDataSheet(exportData) {
  var columns = exportData.columns,
      _exportData$data = exportData.data,
      data = _exportData$data === undefined ? [] : _exportData$data,
      dataStyle = exportData.dataStyle,
      formatter = exportData.formatter,
      headerStyle = exportData.headerStyle,
      noBorders = exportData.noBorders,
      rows = exportData.rows;

  var worksheet = {};
  var colOffset = rows && rows.length > 0 ? 1 : 0;
  var columnTitles = createColumnTitles(columns, colOffset, headerStyle, noBorders);
  var rowOffset = columnTitles.length;

  var merges = [];
  if (rows && rows.length > 0 && rowOffset > 1) {
    merges.push({ s: { c: 0, r: 0 }, e: { c: 0, r: rowOffset - 1 } });
  }

  var cols = [];

  columnTitles.forEach(function (columnRow) {
    return columnRow.forEach(function (columnTitle, colIndex) {
      worksheet[columnTitle.cellRef] = columnTitle.cell;
      if (columnTitle.merge) {
        merges.push(columnTitle.merge);
      }
      cols[colIndex] = { wch: columnTitle.wch };
    });
  });

  if (rows) {
    var wch = 0;
    rows.forEach(function (row, rowIndex) {
      var cellRowIndex = rowIndex + rowOffset;
      var cellRef = XLSX.utils.encode_cell({ c: 0, r: cellRowIndex });
      var title = row.header;
      var width = title ? title.length : 0;
      wch = wch < width ? width : wch;
      var cell = { v: title, t: 's', s: headerStyle };
      if (!noBorders) {
        cell.s = _extends({}, cell.s, border);
      }
      worksheet[cellRef] = cell;
    });
    cols.unshift({ wch: wch });
  }
  worksheet['!cols'] = cols;
  worksheet['!merges'] = merges;

  var createCell = function createCell(value, colIndex, rowIndex) {
    var cellRowIndex = rowIndex + rowOffset;
    var cellColIndex = colIndex + colOffset;
    var cell = { v: value, s: dataStyle };
    if (!noBorders) {
      cell.s = _extends({}, cell.s, border);
    }
    var cellRef = XLSX.utils.encode_cell({ c: cellColIndex, r: cellRowIndex });
    switch (typeof value === 'undefined' ? 'undefined' : _typeof(value)) {
      case 'number':
        {
          cell.t = 'n';
          break;
        }
      case 'boolean':
        {
          cell.t = 'b';
          break;
        }
      default:
        {
          cell.t = 's';
          break;
        }
    }
    worksheet[cellRef] = cell;
  };

  var formatCell = function formatCell(value, column, row) {
    var cellValue = value;
    if (column.valueRender && !column.disableValueRenderInExcel) {
      cellValue = column.valueRender(row);
    } else if (formatter) {
      cellValue = formatter(value);
    }
    return cellValue;
  };

  var detailedColumns = columnTitles.length > 0 ? columnTitles[rowOffset - 1] : [];
  var endColumnIndex = 0;
  if (detailedColumns.length > 0) {
    data.forEach(function (row, rowIndex) {
      detailedColumns.forEach(function (column, colIndex) {
        var cellValue = formatCell(row.getIn ? row.getIn(column.valueKeyPath) : row[column.valueKeyPath], column, row);
        createCell(cellValue, colIndex, rowIndex);
      });
    });
    endColumnIndex = detailedColumns.length + colOffset;
  } else {
    data.forEach(function (row, rowIndex) {
      row.forEach(function (column, colIndex) {
        var cellValue = formatCell(column.value, column, row);
        createCell(cellValue, colIndex, rowIndex);
        var currentColIndex = colIndex + colOffset;
        endColumnIndex = endColumnIndex < currentColIndex ? currentColIndex : endColumnIndex;
        cols.push({ wch: 50 });
      });
    });
  }
  var endRowIndex = (data.length || data.size) + rowOffset;
  var range = {
    s: {
      c: 0,
      r: 0
    },
    e: {
      c: endColumnIndex,
      r: endRowIndex
    }
  };
  if (range.e.c < EXCEL_MAX_COL_COUNT && range.e.r < EXCEL_MAX_ROW_COUNT) {
    worksheet['!ref'] = XLSX.utils.encode_range(range);
  }

  return worksheet;
};

export default (function (sheets, fileName) {
  var workbook = { SheetNames: [], Sheets: {} };

  sheets.forEach(function (sheet, index) {
    var sheetName = sheet.name || 'Sheet ' + (index + 1);
    workbook.SheetNames.push(sheetName);
    var wsSheet = createDataSheet(sheet);
    workbook.Sheets[sheetName] = wsSheet;
  });

  var wbout = XLSX.write(workbook, writeOptions);
  function s2ab(s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for (var i = 0; i !== s.length; ++i) {
      view[i] = s.charCodeAt(i) & 0xFF;
    }
    return buf;
  }

  /* the saveAs call downloads a file on the local machine */
  saveAs(new Blob([s2ab(wbout)], { type: '' }), fileName + '.xlsx');
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdHlsZWQtZXhjZWwtZXhwb3J0LmpzIl0sIm5hbWVzIjpbIlhMU1giLCJzYXZlQXMiLCJ3cml0ZU9wdGlvbnMiLCJ0eXBlIiwiYm9va1NTVCIsImJvb2tUeXBlIiwic2hvd0dyaWRMaW5lcyIsIkVYQ0VMX01BWF9ST1dfQ09VTlQiLCJFWENFTF9NQVhfQ09MX0NPVU5UIiwiYm9yZGVyU3R5bGUiLCJzdHlsZSIsImNvbG9yIiwicmdiIiwiYm9yZGVyIiwidG9wIiwiYm90dG9tIiwibGVmdCIsInJpZ2h0IiwiY3JlYXRlQ29sdW1uVGl0bGVzIiwiY29sdW1ucyIsImNvbE9mZnNldCIsImhlYWRlclN0eWxlIiwibm9Cb3JkZXJzIiwiY2VsbHMiLCJyb3dJbmRleCIsInJvdyIsImZvckVhY2giLCJjb2x1bW4iLCJjb2xJbmRleCIsImNlbGxJbmRleCIsIkFycmF5IiwiaXNBcnJheSIsImNlbGxWYWx1ZSIsImhlYWRlciIsImNlbGwiLCJ2IiwidCIsInMiLCJjZWxsUmVmIiwidXRpbHMiLCJlbmNvZGVfY2VsbCIsImMiLCJyIiwiY2VsbERhdGEiLCJtZXJnZSIsImUiLCJ1cHBlckNlbGwiLCJ1bmRlZmluZWQiLCJ2YWx1ZUtleVBhdGgiLCJ2YWx1ZVJlbmRlciIsImRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwiLCJ3Y2giLCJsZW5ndGgiLCJwdXNoIiwiY3JlYXRlRGF0YVNoZWV0IiwiZXhwb3J0RGF0YSIsImRhdGEiLCJkYXRhU3R5bGUiLCJmb3JtYXR0ZXIiLCJyb3dzIiwid29ya3NoZWV0IiwiY29sdW1uVGl0bGVzIiwicm93T2Zmc2V0IiwibWVyZ2VzIiwiY29scyIsImNvbHVtblJvdyIsImNvbHVtblRpdGxlIiwiY2VsbFJvd0luZGV4IiwidGl0bGUiLCJ3aWR0aCIsInVuc2hpZnQiLCJjcmVhdGVDZWxsIiwidmFsdWUiLCJjZWxsQ29sSW5kZXgiLCJmb3JtYXRDZWxsIiwiZGV0YWlsZWRDb2x1bW5zIiwiZW5kQ29sdW1uSW5kZXgiLCJnZXRJbiIsImN1cnJlbnRDb2xJbmRleCIsImVuZFJvd0luZGV4Iiwic2l6ZSIsInJhbmdlIiwiZW5jb2RlX3JhbmdlIiwic2hlZXRzIiwiZmlsZU5hbWUiLCJ3b3JrYm9vayIsIlNoZWV0TmFtZXMiLCJTaGVldHMiLCJzaGVldCIsImluZGV4Iiwic2hlZXROYW1lIiwibmFtZSIsIndzU2hlZXQiLCJ3Ym91dCIsIndyaXRlIiwiczJhYiIsImJ1ZiIsIkFycmF5QnVmZmVyIiwidmlldyIsIlVpbnQ4QXJyYXkiLCJpIiwiY2hhckNvZGVBdCIsIkJsb2IiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQSxPQUFPQSxJQUFQLE1BQWlCLGFBQWpCO0FBQ0EsT0FBT0MsTUFBUCxNQUFtQixZQUFuQjs7QUFFQSxJQUFNQyxlQUFlO0FBQ25CQyxRQUFNLFFBRGE7QUFFbkJDLFdBQVMsS0FGVTtBQUduQkMsWUFBVSxNQUhTO0FBSW5CQyxpQkFBZTtBQUpJLENBQXJCOztBQU9BLElBQU1DLHNCQUFzQixPQUE1QjtBQUNBLElBQU1DLHNCQUFzQixLQUE1Qjs7QUFFQTtBQUNBLElBQU1DLGNBQWMsRUFBRUMsT0FBTyxNQUFULEVBQWlCQyxPQUFPLEVBQUVDLEtBQUssUUFBUCxFQUF4QixFQUFwQjtBQUNBLElBQU1DLFNBQVM7QUFDYkEsVUFBUTtBQUNOQyxTQUFLTCxXQURDO0FBRU5NLFlBQVFOLFdBRkY7QUFHTk8sVUFBTVAsV0FIQTtBQUlOUSxXQUFPUjtBQUpEO0FBREssQ0FBZjs7QUFTQSxJQUFNUyxxQkFBcUIsU0FBckJBLGtCQUFxQixHQU90QjtBQUFBLE1BTkhDLE9BTUcsdUVBTk8sRUFNUDtBQUFBLE1BTEhDLFNBS0c7QUFBQSxNQUpIQyxXQUlHO0FBQUEsTUFISEMsU0FHRyx1RUFIUyxLQUdUO0FBQUEsTUFGSEMsS0FFRyx1RUFGSyxFQUVMO0FBQUEsTUFESEMsUUFDRyx1RUFEUSxDQUNSOztBQUNILE1BQU1DLE1BQU0sRUFBWjtBQUNBTixVQUFRTyxPQUFSLENBQWdCLFVBQUNDLE1BQUQs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QVQsRUFBc0I7QUFDbkMsTUFBTUMsV0FBVyxFQUFFQyxZQUFZLEVBQWQsRUFBa0JDLFFBQVEsRUFBMUIsRUFBakI7O0FBRUFKLFNBQU96RCxPQUFQLENBQWUsVUFBQzhELEtBQUQsRUFBUUMsS0FBUixFQUFrQjtBQUMvQixRQUFNQyxZQUFZRixNQUFNRyxJQUFOLGdCQUF1QkYsUUFBUSxDQUEvQixDQUFsQjtBQUNBSixhQUFTQyxVQUFULENBQW9CakMsSUFBcEIsQ0FBeUJxQyxTQUF6QjtBQUNBLFFBQU1FLFVBQVV0QyxnQkFBZ0JrQyxLQUFoQixDQUFoQjtBQUNBSCxhQUFTRSxNQUFULENBQWdCRyxTQUFoQixJQUE2QkUsT0FBN0I7QUFDRCxHQUxEOztBQU9BLE1BQU1DLFFBQVE3RixLQUFLOEYsS0FBTCxDQUFXVCxRQUFYLEVBQXFCbkYsWUFBckIsQ0FBZDtBQUNBLFdBQVM2RixJQUFULENBQWMxRCxDQUFkLEVBQWlCO0FBQ2YsUUFBTTJELE1BQU0sSUFBSUMsV0FBSixDQUFnQjVELEVBQUVlLE1BQWxCLENBQVo7QUFDQSxRQUFNOEMsT0FBTyxJQUFJQyxVQUFKLENBQWVILEdBQWYsQ0FBYjtBQUNBLFNBQUssSUFBSUksSUFBSSxDQUFiLEVBQWdCQSxNQUFNL0QsRUFBRWUsTUFBeEIsRUFBZ0MsRUFBRWdELENBQWxDLEVBQXFDO0FBQ25DRixXQUFLRSxDQUFMLElBQVUvRCxFQUFFZ0UsVUFBRixDQUFhRCxDQUFiLElBQWtCLElBQTVCO0FBQ0Q7QUFDRCxXQUFPSixHQUFQO0FBQ0Q7O0FBRUQ7QUFDQS9GLFNBQU8sSUFBSXFHLElBQUosQ0FBUyxDQUFDUCxLQUFLRixLQUFMLENBQUQsQ0FBVCxFQUF3QixFQUFFMUYsTUFBTSxFQUFSLEVBQXhCLENBQVAsRUFBaURpRixRQUFqRDtBQUNELENBdEJEIiwiZmlsZSI6InN0eWxlZC1leGNlbC1leHBvcnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBjb25zaXN0ZW50LXJldHVybiAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tcGx1c3BsdXMgKi9cbi8qIGVzbGludC1kaXNhYmxlIG5vLWJpdHdpc2UgKi9cbmltcG9ydCBYTFNYIGZyb20gJ3hsc3gtc3R5bGVzJztcbmltcG9ydCBzYXZlQXMgZnJvbSAnZmlsZS1zYXZlcic7XG5cbmNvbnN0IHdyaXRlT3B0aW9ucyA9IHtcbiAgdHlwZTogJ2JpbmFyeScsXG4gIGJvb2tTU1Q6IGZhbHNlLFxuICBib29rVHlwZTogJ3hsc3gnLFxuICBzaG93R3JpZExpbmVzOiBmYWxzZSxcbn07XG5cbmNvbnN0IEVYQ0VMX01BWF9ST1dfQ09VTlQgPSAxMDQ4NTc2O1xuY29uc3QgRVhDRUxfTUFYX0NPTF9DT1VOVCA9IDE2Mzg0O1xuXG4vLyBodHRwczovL3d3dy5ucG1qcy5jb20vcGFja2FnZS94bHN4LXN0eWxlcyNjZWxsLXN0eWxlc1xuY29uc3QgYm9yZGVyU3R5bGUgPSB7IHN0eWxlOiAndGhpbicsIGNvbG9yOiB7IHJnYjogJ0NDQ0NDQycgfSB9O1xuY29uc3QgYm9yZGVyID0ge1xuICBib3JkZXI6IHtcbiAgICB0b3A6IGJvcmRlclN0eWxlLFxuICAgIGJvdHRvbTogYm9yZGVyU3R5bGUsXG4gICAgbGVmdDogYm9yZGVyU3R5bGUsXG4gICAgcmlnaHQ6IGJvcmRlclN0eWxlLFxuICB9LFxufTtcblxuY29uc3QgY3JlYXRlQ29sdW1uVGl0bGVzID0gKFxuICBjb2x1bW5zID0gW10sXG4gIGNvbE9mZnNldCxcbiAgaGVhZGVyU3R5bGUsXG4gIG5vQm9yZGVycyA9IGZhbHNlLFxuICBjZWxscyA9IFtdLFxuICByb3dJbmRleCA9IDAsXG4pID0+IHtcbiAgY29uc3Qgcm93ID0gW107XG4gIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uLCBjb2xJbmRleCkgPT4ge1xuICAgIGNvbnN0IGNlbGxJbmRleCA9IGNvbE9mZnNldCArIGNvbEluZGV4O1xuICAgIGlmIChBcnJheS5pc0FycmF5KGNvbHVtbikpIHtcbiAgICAgIHJldHVybiBjcmVhdGVDb2x1bW5UaXRsZXMoY29sdW1uLCBjb2xPZmZzZXQsIGhlYWRlclN0eWxlLCBub0JvcmRlcnMsIGNlbGxzLCBjb2xJbmRleCk7XG4gICAgfVxuICAgIGNvbnN0IGNlbGxWYWx1ZSA9IChjb2x1bW4gfHwge30pLmhlYWRlciB8fCAnJztcbiAgICBjb25zdCBjZWxsID0geyB2OiBjZWxsVmFsdWUsIHQ6ICdzJywgczogaGVhZGVyU3R5bGUgfTtcbiAgICBpZiAoIW5vQm9yZGVycykge1xuICAgICAgY2VsbC5zID0geyAuLi5jZWxsLnMsIC4uLmJvcmRlciB9O1xuICAgIH1cbiAgICBjb25zdCBjZWxsUmVmID0gWExTWC51dGlscy5lbmNvZGVfY2VsbCh7IGM6IGNlbGxJbmRleCwgcjogcm93SW5kZXggfSk7XG4gICAgY29uc3QgY2VsbERhdGEgPSB7IGNlbGwsIGNlbGxSZWYgfTtcbiAgICBpZiAoY29sdW1uICYmIGNvbHVtbi5tZXJnZSA+IDEpIHtcbiAgICAgIGNlbGxEYXRhLm1lcmdlID0ge1xuICAgICAgICBzOiB7XG4gICAgICAgICAgYzogY2VsbEluZGV4LFxuICAgICAgICAgIHI6IHJvd0luZGV4LFxuICAgICAgICB9LFxuICAgICAgICBlOiB7XG4gICAgICAgICAgYzogY2VsbEluZGV4ICsgKGNvbHVtbi5tZXJnZSAtIDEpLFxuICAgICAgICAgIHI6IHJvd0luZGV4LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgdXBwZXJDZWxsID0gcm93SW5kZXggPiAwID8gY2VsbHNbcm93SW5kZXggLSAxXVtjb2xJbmRleF0gOiB1bmRlZmluZWQ7XG4gICAgaWYgKGNvbHVtbiAmJiBjb2x1bW4udmFsdWVLZXlQYXRoKSB7XG4gICAgICBjZWxsRGF0YS52YWx1ZUtleVBhdGggPSBjb2x1bW4udmFsdWVLZXlQYXRoO1xuICAgICAgY2VsbERhdGEudmFsdWVSZW5kZXIgPSBjb2x1bW4udmFsdWVSZW5kZXI7XG4gICAgICBjZWxsRGF0YS5kaXNhYmxlVmFsdWVSZW5kZXJJbkV4Y2VsID0gY29sdW1uLmRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWw7XG4gICAgfSBlbHNlIGlmIChyb3dJbmRleCA+IDApIHtcbiAgICAgIGNlbGxEYXRhLnZhbHVlS2V5UGF0aCA9IHVwcGVyQ2VsbC52YWx1ZUtleVBhdGg7XG4gICAgfVxuICAgIGNvbnN0IHdjaCA9IHVwcGVyQ2VsbCAmJiAhdXBwZXJDZWxsLm1lcmdlICYmIHVwcGVyQ2VsbC53Y2ggPiBjZWxsVmFsdWUubGVuZ3RoXG4gICAgICA/IHVwcGVyQ2VsbC53Y2hcbiAgICAgIDogY2VsbFZhbHVlLmxlbmd0aDtcbiAgICBjZWxsRGF0YS53Y2ggPSB3Y2g7XG4gICAgcm93LnB1c2goY2VsbERhdGEpO1xuICB9KTtcbiAgaWYgKHJvdy5sZW5ndGggPiAwKSB7XG4gICAgY2VsbHMucHVzaChyb3cpO1xuICB9XG4gIHJldHVybiBjZWxscztcbn07XG5cbmNvbnN0IGNyZWF0ZURhdGFTaGVldCA9IChleHBvcnREYXRhKSA9PiB7XG4gIGNvbnN0IHtcbiAgICBjb2x1bW5zLFxuICAgIGRhdGEgPSBbXSxcbiAgICBkYXRhU3R5bGUsXG4gICAgZm9ybWF0dGVyLFxuICAgIGhlYWRlclN0eWxlLFxuICAgIG5vQm9yZGVycyxcbiAgICByb3dzLFxuICB9ID0gZXhwb3J0RGF0YTtcbiAgY29uc3Qgd29ya3NoZWV0ID0ge307XG4gIGNvbnN0IGNvbE9mZnNldCA9IHJvd3MgJiYgcm93cy5sZW5ndGggPiAwID8gMSA6IDA7XG4gIGNvbnN0IGNvbHVtblRpdGxlcyA9IGNyZWF0ZUNvbHVtblRpdGxlcyhjb2x1bW5zLCBjb2xPZmZzZXQsIGhlYWRlclN0eWxlLCBub0JvcmRlcnMpO1xuICBjb25zdCByb3dPZmZzZXQgPSBjb2x1bW5UaXRsZXMubGVuZ3RoO1xuXG4gIGNvbnN0IG1lcmdlcyA9IFtdO1xuICBpZiAocm93cyAmJiByb3dzLmxlbmd0aCA+IDAgJiYgcm93T2Zmc2V0ID4gMSkge1xuICAgIG1lcmdlcy5wdXNoKHsgczogeyBjOiAwLCByOiAwIH0sIGU6IHsgYzogMCwgcjogcm93T2Zmc2V0IC0gMSB9IH0pO1xuICB9XG5cbiAgY29uc3QgY29scyA9IFtdO1xuXG4gIGNvbHVtblRpdGxlcy5mb3JFYWNoKGNvbHVtblJvdyA9PiAoXG4gICAgY29sdW1uUm93LmZvckVhY2goKGNvbHVtblRpdGxlLCBjb2xJbmRleCkgPT4ge1xuICAgICAgd29ya3NoZWV0W2NvbHVtblRpdGxlLmNlbGxSZWZdID0gY29sdW1uVGl0bGUuY2VsbDtcbiAgICAgIGlmIChjb2x1bW5UaXRsZS5tZXJnZSkge1xuICAgICAgICBtZXJnZXMucHVzaChjb2x1bW5UaXRsZS5tZXJnZSk7XG4gICAgICB9XG4gICAgICBjb2xzW2NvbEluZGV4XSA9IHsgd2NoOiBjb2x1bW5UaXRsZS53Y2ggfTtcbiAgICB9KVxuICApKTtcblxuICBpZiAocm93cykge1xuICAgIGxldCB3Y2ggPSAwO1xuICAgIHJvd3MuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgY29uc3QgY2VsbFJvd0luZGV4ID0gcm93SW5kZXggKyByb3dPZmZzZXQ7XG4gICAgICBjb25zdCBjZWxsUmVmID0gWExTWC51dGlscy5lbmNvZGVfY2VsbCh7IGM6IDAsIHI6IGNlbGxSb3dJbmRleCB9KTtcbiAgICAgIGNvbnN0IHRpdGxlID0gcm93LmhlYWRlcjtcbiAgICAgIGNvbnN0IHdpZHRoID0gdGl0bGUgPyB0aXRsZS5sZW5ndGggOiAwO1xuICAgICAgd2NoID0gd2NoIDwgd2lkdGggPyB3aWR0aCA6IHdjaDtcbiAgICAgIGNvbnN0IGNlbGwgPSB7IHY6IHRpdGxlLCB0OiAncycsIHM6IGhlYWRlclN0eWxlIH07XG4gICAgICBpZiAoIW5vQm9yZGVycykge1xuICAgICAgICBjZWxsLnMgPSB7IC4uLmNlbGwucywgLi4uYm9yZGVyIH07XG4gICAgICB9XG4gICAgICB3b3Jrc2hlZXRbY2VsbFJlZl0gPSBjZWxsO1xuICAgIH0pO1xuICAgIGNvbHMudW5zaGlmdCh7IHdjaCB9KTtcbiAgfVxuICB3b3Jrc2hlZXRbJyFjb2xzJ10gPSBjb2xzO1xuICB3b3Jrc2hlZXRbJyFtZXJnZXMnXSA9IG1lcmdlcztcblxuICBjb25zdCBjcmVhdGVDZWxsID0gKHZhbHVlLCBjb2xJbmRleCwgcm93SW5kZXgpID0+IHtcbiAgICBjb25zdCBjZWxsUm93SW5kZXggPSByb3dJbmRleCArIHJvd09mZnNldDtcbiAgICBjb25zdCBjZWxsQ29sSW5kZXggPSBjb2xJbmRleCArIGNvbE9mZnNldDtcbiAgICBjb25zdCBjZWxsID0geyB2OiB2YWx1ZSwgczogZGF0YVN0eWxlIH07XG4gICAgaWYgKCFub0JvcmRlcnMpIHtcbiAgICAgIGNlbGwucyA9IHsgLi4uY2VsbC5zLCAuLi5ib3JkZXIgfTtcbiAgICB9XG4gICAgY29uc3QgY2VsbFJlZiA9IFhMU1gudXRpbHMuZW5jb2RlX2NlbGwoeyBjOiBjZWxsQ29sSW5kZXgsIHI6IGNlbGxSb3dJbmRleCB9KTtcbiAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkge1xuICAgICAgY2FzZSAoJ251bWJlcicpOiB7XG4gICAgICAgIGNlbGwudCA9ICduJztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICgnYm9vbGVhbicpOiB7XG4gICAgICAgIGNlbGwudCA9ICdiJztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIGNlbGwudCA9ICdzJztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHdvcmtzaGVldFtjZWxsUmVmXSA9IGNlbGw7XG4gIH07XG5cbiAgY29uc3QgZm9ybWF0Q2VsbCA9ICh2YWx1ZSwgY29sdW1uLCByb3cpID0+IHtcbiAgICBsZXQgY2VsbFZhbHVlID0gdmFsdWU7XG4gICAgaWYgKGNvbHVtbi52YWx1ZVJlbmRlciAmJiAhY29sdW1uLmRpc2FibGVWYWx1ZVJlbmRlckluRXhjZWwpIHtcbiAgICAgIGNlbGxWYWx1ZSA9IGNvbHVtbi52YWx1ZVJlbmRlcihyb3cpO1xuICAgIH0gZWxzZSBpZiAoZm9ybWF0dGVyKSB7XG4gICAgICBjZWxsVmFsdWUgPSBmb3JtYXR0ZXIodmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gY2VsbFZhbHVlO1xuICB9O1xuXG4gIGNvbnN0IGRldGFpbGVkQ29sdW1ucyA9IGNvbHVtblRpdGxlcy5sZW5ndGggPiAwID8gY29sdW1uVGl0bGVzW3Jvd09mZnNldCAtIDFdIDogW107XG4gIGxldCBlbmRDb2x1bW5JbmRleCA9IDA7XG4gIGlmIChkZXRhaWxlZENvbHVtbnMubGVuZ3RoID4gMCkge1xuICAgIGRhdGEuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgZGV0YWlsZWRDb2x1bW5zLmZvckVhY2goKGNvbHVtbiwgY29sSW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgY2VsbFZhbHVlID0gZm9ybWF0Q2VsbChyb3cuZ2V0SW5cbiAgICAgICAgICA/IHJvdy5nZXRJbihjb2x1bW4udmFsdWVLZXlQYXRoKVxuICAgICAgICAgIDogcm93W2NvbHVtbi52YWx1ZUtleVBhdGhdLCBjb2x1bW4sIHJvdyk7XG4gICAgICAgIGNyZWF0ZUNlbGwoY2VsbFZhbHVlLCBjb2xJbmRleCwgcm93SW5kZXgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZW5kQ29sdW1uSW5kZXggPSBkZXRhaWxlZENvbHVtbnMubGVuZ3RoICsgY29sT2Zmc2V0O1xuICB9IGVsc2Uge1xuICAgIGRhdGEuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgcm93LmZvckVhY2goKGNvbHVtbiwgY29sSW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgY2VsbFZhbHVlID0gZm9ybWF0Q2VsbChjb2x1bW4udmFsdWUsIGNvbHVtbiwgcm93KTtcbiAgICAgICAgY3JlYXRlQ2VsbChjZWxsVmFsdWUsIGNvbEluZGV4LCByb3dJbmRleCk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb2xJbmRleCA9IGNvbEluZGV4ICsgY29sT2Zmc2V0O1xuICAgICAgICBlbmRDb2x1bW5JbmRleCA9IGVuZENvbHVtbkluZGV4IDwgY3VycmVudENvbEluZGV4ID8gY3VycmVudENvbEluZGV4IDogZW5kQ29sdW1uSW5kZXg7XG4gICAgICAgIGNvbHMucHVzaCh7IHdjaDogNTAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBjb25zdCBlbmRSb3dJbmRleCA9IChkYXRhLmxlbmd0aCB8fCBkYXRhLnNpemUpICsgcm93T2Zmc2V0O1xuICBjb25zdCByYW5nZSA9IHtcbiAgICBzOiB7XG4gICAgICBjOiAwLFxuICAgICAgcjogMCxcbiAgICB9LFxuICAgIGU6IHtcbiAgICAgIGM6IGVuZENvbHVtbkluZGV4LFxuICAgICAgcjogZW5kUm93SW5kZXgsXG4gICAgfSxcbiAgfTtcbiAgaWYgKHJhbmdlLmUuYyA8IEVYQ0VMX01BWF9DT0xfQ09VTlQgJiYgcmFuZ2UuZS5yIDwgRVhDRUxfTUFYX1JPV19DT1VOVCkge1xuICAgIHdvcmtzaGVldFsnIXJlZiddID0gWExTWC51dGlscy5lbmNvZGVfcmFuZ2UocmFuZ2UpO1xuICB9XG5cbiAgcmV0dXJuIHdvcmtzaGVldDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IChzaGVldHMsIGZpbGVOYW1lKSA9PiB7XG4gIGNvbnN0IHdvcmtib29rID0geyBTaGVldE5hbWVzOiBbXSwgU2hlZXRzOiB7fSB9O1xuXG4gIHNoZWV0cy5mb3JFYWNoKChzaGVldCwgaW5kZXgpID0+IHtcbiAgICBjb25zdCBzaGVldE5hbWUgPSBzaGVldC5uYW1lIHx8IGBTaGVldCAke2luZGV4ICsgMX1gO1xuICAgIHdvcmtib29rLlNoZWV0TmFtZXMucHVzaChzaGVldE5hbWUpO1xuICAgIGNvbnN0IHdzU2hlZXQgPSBjcmVhdGVEYXRhU2hlZXQoc2hlZXQpO1xuICAgIHdvcmtib29rLlNoZWV0c1tzaGVldE5hbWVdID0gd3NTaGVldDtcbiAgfSk7XG5cbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKHdvcmtib29rLCB3cml0ZU9wdGlvbnMpO1xuICBmdW5jdGlvbiBzMmFiKHMpIHtcbiAgICBjb25zdCBidWYgPSBuZXcgQXJyYXlCdWZmZXIocy5sZW5ndGgpO1xuICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBzLmxlbmd0aDsgKytpKSB7XG4gICAgICB2aWV3W2ldID0gcy5jaGFyQ29kZUF0KGkpICYgMHhGRjtcbiAgICB9XG4gICAgcmV0dXJuIGJ1ZjtcbiAgfVxuXG4gIC8qIHRoZSBzYXZlQXMgY2FsbCBkb3dubG9hZHMgYSBmaWxlIG9uIHRoZSBsb2NhbCBtYWNoaW5lICovXG4gIHNhdmVBcyhuZXcgQmxvYihbczJhYih3Ym91dCldLCB7IHR5cGU6ICcnIH0pLCBgJHtmaWxlTmFtZX0ueGxzeGApO1xufTtcbiJdfQ==